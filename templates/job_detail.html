{% extends "base.html" %}
{% block title %}{{ posting.title }} - Jobs - RefCheck AI{% endblock %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
  <a href="{{ url_for('jobs') }}" style="color: var(--text-muted); font-size: 0.9rem;">← Back to Jobs</a>
  <div style="display:flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-top: 0.5rem;">
    <div style="min-width: 0;">
      <h1 style="font-size: 1.75rem; font-weight: 600; letter-spacing: -0.02em; margin-bottom: 0.25rem;">
        {{ posting.title }}
      </h1>
      <div style="color: var(--text-muted); font-size: 0.95rem;">
        {{ posting.department or '—' }} • {{ posting.location or '—' }} • {{ posting.employment_type or '—' }} • {{ posting.seniority or '—' }}
      </div>
      <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.35rem;">
        Status: <strong style="color: var(--text-primary);">{{ (posting.status or 'draft')|capitalize }}</strong>
      </div>
      {% if posting.status == 'published' %}
      <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
        <span style="color: var(--text-muted); font-size: 0.85rem;">Public URL:</span>
        <code id="public-url" style="font-size: 0.85rem; background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: monospace;">{{ request.url_root.rstrip('/') }}/apply/jobs/{{ posting.public_id }}</code>
        <button class="btn btn-secondary btn-sm" onclick="copyPublicUrl()" id="copy-url-btn" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;">Copy URL</button>
        <span id="copy-status" style="color: var(--success); font-size: 0.85rem;"></span>
      </div>
      {% endif %}
    </div>
    <div style="display:flex; gap: 0.75rem; align-items: center; flex-shrink: 0;">
      <a class="btn btn-secondary" href="{{ url_for('edit_job', job_id=posting.id) }}">Edit Job</a>
      <a class="btn btn-secondary" href="{{ url_for('new_job') }}">New Job</a>
    </div>
  </div>
</div>

<div class="grid" style="display:grid; grid-template-columns: 1.2fr 1fr; gap: 1.25rem;">
  <div class="card">
    <div class="card-header">
      <span>Job Description</span>
      <span style="font-weight: 400; color: var(--text-muted); font-size: 0.85rem;">Last updated {{ posting.updated_at.strftime('%b %d') if posting.updated_at else '' }}</span>
    </div>
    <div class="card-body">
      {% if posting.description_html %}
        <div style="color: var(--text-secondary); white-space: pre-wrap;">{{ posting.description_html }}</div>
      {% elif posting.description_raw %}
        <div style="color: var(--text-secondary); white-space: pre-wrap;">{{ posting.description_raw }}</div>
      {% else %}
        <p style="color: var(--text-muted);">No job description yet.</p>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span>Applicants</span>
      <span style="font-weight: 400; color: var(--text-muted); font-size: 0.85rem;">{{ applications|length }} total</span>
    </div>
    <div class="card-body">
      <div style="display:flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <button class="btn btn-secondary btn-sm" onclick="screenAll()" id="screen-all-btn">AI screen applied</button>
        <span id="screen-status" style="color: var(--text-muted); font-size: 0.85rem;"></span>
      </div>
      {% if applications|length == 0 %}
        <p style="color: var(--text-muted);">No applications yet.</p>
        <p class="hint">Next we’ll add a public job page + application form that feeds this list.</p>
      {% else %}
        {% set stages = ['applied','screened','interview','offer','hired','rejected'] %}
        <div style="display:grid; grid-template-columns: repeat(6, minmax(220px, 1fr)); gap: 0.75rem; overflow-x: auto; padding-bottom: 0.25rem;">
          {% for s in stages %}
            <div style="min-width: 220px;">
              <div style="font-weight: 700; font-size: 0.85rem; letter-spacing: -0.01em; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">
                {{ s }}
              </div>
              <div style="display:flex; flex-direction: column; gap: 0.75rem;">
                {% for a in applications if (a.stage or 'applied') == s %}
            <div class="card" style="border-color: var(--border-light);">
              <div class="card-body" style="padding: 1rem 1.25rem;">
                <div style="display:flex; justify-content: space-between; align-items: center; gap: 1rem;">
                  <div style="min-width:0;">
                    <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ a.full_name }}</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">{{ a.email }}{% if a.phone %} • {{ a.phone }}{% endif %}</div>
                  </div>
                  <div style="text-align:right; flex-shrink:0;">
                    <select onchange="moveStage('{{ a.id }}', this.value)" style="padding: 0.35rem 0.5rem; font-size: 0.85rem;">
                      {% for opt in stages %}
                        <option value="{{ opt }}" {% if opt == (a.stage or 'applied') %}selected{% endif %}>{{ opt|capitalize }}</option>
                      {% endfor %}
                    </select>
                    {% if (a.stage or 'applied') == 'hired' and a.candidate_id %}
                      <div style="margin-top: 0.35rem;">
                        <a class="btn btn-secondary btn-sm" href="{{ url_for('view_candidate', candidate_id=a.candidate_id) }}" style="width:100%; justify-content:center;">View Candidate</a>
                      </div>
                    {% endif %}
                  </div>
                </div>
                {% if a.ai_score is not none %}
                  <div style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                    AI score: <strong>{{ a.ai_score }}</strong>
                  </div>
                  {% if a.ai_summary %}
                    <div style="margin-top: 0.25rem; color: var(--text-muted); font-size: 0.9rem;">
                      {{ a.ai_summary }}
                    </div>
                  {% endif %}
                {% else %}
                  <div style="margin-top: 0.75rem;">
                    <button class="btn btn-secondary btn-sm" onclick="screenOne('{{ a.id }}')" id="screen-btn-{{ a.id }}">AI screen</button>
                  </div>
                {% endif %}
              </div>
            </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function screenOne(appId) {
  const btn = document.getElementById(`screen-btn-${appId}`);
  if (btn) btn.disabled = true;
  try {
    const resp = await fetch(`/api/jobs/{{ posting.id }}/applications/${appId}/ai-screen`, { method: 'POST', credentials: 'same-origin' });
    const data = await resp.json();
    if (!resp.ok || data.error) throw new Error(data.error || 'Failed');
    window.location.reload();
  } catch (e) {
    alert('Error: ' + e.message);
    if (btn) btn.disabled = false;
  }
}

async function screenAll() {
  const btn = document.getElementById('screen-all-btn');
  const status = document.getElementById('screen-status');
  btn.disabled = true;
  status.textContent = 'Screening...';
  try {
    const resp = await fetch(`/api/jobs/{{ posting.id }}/applications/ai-screen-all`, { method: 'POST', credentials: 'same-origin' });
    const data = await resp.json();
    if (!resp.ok || data.error) throw new Error(data.error || 'Failed');
    status.textContent = 'Done';
    window.location.reload();
  } catch (e) {
    status.textContent = '';
    alert('Error: ' + e.message);
    btn.disabled = false;
  }
}

async function moveStage(appId, stage) {
  try {
    const resp = await fetch(`/api/jobs/{{ posting.id }}/applications/${appId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ stage })
    });
    const data = await resp.json();
    if (!resp.ok || data.error) throw new Error(data.error || 'Failed');
    // no full reload needed, but keep it simple for v1
    window.location.reload();
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

function copyPublicUrl() {
  const url = document.getElementById('public-url').textContent;
  navigator.clipboard.writeText(url).then(() => {
    const status = document.getElementById('copy-status');
    status.textContent = 'Copied!';
    setTimeout(() => { status.textContent = ''; }, 2000);
  }).catch(() => {
    alert('Failed to copy. Please copy manually: ' + url);
  });
}
</script>
{% endblock %}

