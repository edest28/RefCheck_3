{% extends "base.html" %}
{% block title %}Edit Job - RefCheck AI{% endblock %}

{% block extra_head %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
  .edit-job-page { max-width: 1000px; margin: 0 auto; padding-bottom: 3rem; }
  .edit-job-page .back-link { font-size: 0.875rem; color: var(--text-muted); display: inline-block; margin-bottom: 1.5rem; }
  .edit-job-page .back-link:hover { color: var(--accent); }

  .edit-job-page .page-header {
    display: flex; justify-content: space-between; align-items: flex-start; gap: 1.5rem; flex-wrap: wrap;
    margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-light);
  }
  .edit-job-page .page-title { font-size: 1.5rem; font-weight: 600; letter-spacing: -0.02em; margin: 0 0 0.25rem 0; }
  .edit-job-page .page-meta { font-size: 0.875rem; color: var(--text-muted); }
  .edit-job-page .page-actions { display: flex; gap: 0.75rem; align-items: center; }
  .edit-job-page .status-pill {
    display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.25rem 0.65rem; border-radius: 999px;
    font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;
  }
  .edit-job-page .status-pill.published { background: var(--success-bg); color: var(--success); }
  .edit-job-page .status-pill.draft { background: var(--bg-tertiary); color: var(--text-muted); }

  .edit-job-page .alert-errors {
    background: var(--danger-bg); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.25);
    border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; font-size: 0.875rem;
  }
  .edit-job-page .alert-errors ul { margin: 0.5rem 0 0 1.25rem; padding: 0; }

  .edit-job-page .form-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;
  }
  @media (max-width: 640px) { .edit-job-page .form-grid { grid-template-columns: 1fr; } }
  .edit-job-page .form-group { margin-bottom: 1.25rem; }
  .edit-job-page .form-group.full-width { grid-column: 1 / -1; }
  .edit-job-page .form-label {
    display: block; font-size: 0.8125rem; font-weight: 600; color: var(--text-primary);
    margin-bottom: 0.375rem; letter-spacing: -0.01em;
  }
  .edit-job-page .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }
  .edit-job-page .form-input {
    width: 100%; font-size: 0.9375rem; padding: 0.625rem 0.875rem; border-radius: 8px;
    border: 1px solid var(--border); background: var(--bg-primary); font-family: inherit;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .edit-job-page .form-input:focus {
    outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0, 26, 163, 0.08);
  }
  .edit-job-page .form-input.has-error { border-color: var(--danger); }
  .edit-job-page .form-error { font-size: 0.8125rem; color: var(--danger); margin-top: 0.25rem; }

  .edit-job-page .card {
    background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px;
    overflow: hidden; margin-bottom: 1.5rem;
  }
  .edit-job-page .card-header {
    padding: 1rem 1.25rem; font-size: 0.9375rem; font-weight: 600; letter-spacing: -0.01em;
    background: var(--bg-secondary); border-bottom: 1px solid var(--border-light); color: var(--text-primary);
  }
  .edit-job-page .card-body { padding: 1.25rem 1.5rem; }
  .edit-job-page .company-badge {
    display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem;
    background: var(--bg-secondary); border-radius: 8px; font-size: 0.875rem; border: 1px solid var(--border-light);
  }
  .edit-job-page .company-badge a { font-size: 0.8125rem; color: var(--text-muted); }
  .edit-job-page .divider { border-top: 1px solid var(--border-light); margin-top: 1.25rem; padding-top: 1.25rem; }
  .edit-job-page .btn-block { width: 100%; }
  .edit-job-page .btn-danger-outline {
    background: transparent; color: var(--danger); border: 1px solid var(--danger);
    padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer;
  }
  .edit-job-page .btn-danger-outline:hover { background: var(--danger-bg); }

  .edit-job-page .editor-wrap { min-height: 360px; display: flex; flex-direction: column; }
  .edit-job-page .ql-toolbar.ql-snow { border-color: var(--border-light); background: var(--bg-secondary); border-radius: 10px 10px 0 0; }
  .edit-job-page .ql-container.ql-snow { border-color: var(--border-light); border-radius: 0 0 10px 10px; min-height: 320px; font-size: 0.9375rem; }
  .edit-job-page .ql-editor { min-height: 300px; }
</style>
{% endblock %}

{% block content %}
<div class="edit-job-page">
  <a href="{{ url_for('jobs.view_job', job_id=job.id) }}" class="back-link">← Back to Job</a>

  <div class="page-header">
    <div>
      <h1 class="page-title">Edit job</h1>
      <p class="page-meta">
        {% if job.company %}{{ job.company.name }}{% elif job.company_name %}{{ job.company_name }}{% endif %}
        {% if job.company or job.company_name %} · {% endif %}
        <span class="status-pill {{ job.status or 'draft' }}">{{ (job.status or 'draft')|capitalize }}</span>
      </p>
    </div>
    <div class="page-actions">
      <a class="btn btn-secondary" href="{{ url_for('jobs.view_job', job_id=job.id) }}">Cancel</a>
      <button type="button" class="btn btn-primary" onclick="submitForm('{{ job.status }}')">Save changes</button>
    </div>
  </div>

  {% if errors %}
  <div class="alert-errors" role="alert">
    <strong>Please fix the following:</strong>
    <ul>{% for field, msg in errors.items() %}<li>{{ msg }}</li>{% endfor %}</ul>
  </div>
  {% endif %}

  <form method="POST" action="{{ url_for('jobs.update_job', job_id=job.id) }}" id="jobForm">
    <input type="hidden" name="status" id="status" value="{{ form_data.status if form_data else job.status }}">
    <input type="hidden" name="description_html" id="description_html">
    <input type="hidden" name="description_raw" id="description_raw">

    <div class="card">
      <div class="card-header">Details</div>
      <div class="card-body">
        {% if job.company %}
        <div class="form-group">
          <span class="form-label">Company</span>
          <div class="company-badge">
            <strong>{{ job.company.name }}</strong>
            <a href="{{ url_for('companies.view_company', company_id=job.company.id) }}">View profile</a>
          </div>
        </div>
        {% endif %}

        <div class="form-grid">
          <div class="form-group">
            <label for="title" class="form-label">Job title <span style="color: var(--danger);">*</span></label>
            <input id="title" name="title" class="form-input {{ 'has-error' if errors and errors.title else '' }}"
              placeholder="e.g. Senior Engineer" value="{{ (form_data.title if form_data else job.title) }}" required maxlength="255" />
            {% if errors and errors.title %}<div class="form-error">{{ errors.title }}</div>{% endif %}
          </div>
          <div class="form-group">
            <label for="department" class="form-label">Department</label>
            <input id="department" name="department" class="form-input {{ 'has-error' if errors and errors.department else '' }}"
              placeholder="e.g. Engineering" value="{{ (form_data.department if form_data else job.department) or '' }}" maxlength="100" />
            {% if errors and errors.department %}<div class="form-error">{{ errors.department }}</div>{% endif %}
          </div>
          <div class="form-group">
            <label for="location" class="form-label">Location</label>
            <input id="location" name="location" class="form-input {{ 'has-error' if errors and errors.location else '' }}"
              placeholder="e.g. Remote" value="{{ (form_data.location if form_data else job.location) or '' }}" maxlength="255" />
            {% if errors and errors.location %}<div class="form-error">{{ errors.location }}</div>{% endif %}
          </div>
          <div class="form-group">
            <label for="employment_type" class="form-label">Type</label>
            <select id="employment_type" name="employment_type" class="form-input">
              <option value="">—</option>
              <option value="Full-time" {% if (form_data.employment_type if form_data else job.employment_type) == 'Full-time' %}selected{% endif %}>Full-time</option>
              <option value="Part-time" {% if (form_data.employment_type if form_data else job.employment_type) == 'Part-time' %}selected{% endif %}>Part-time</option>
              <option value="Contract" {% if (form_data.employment_type if form_data else job.employment_type) == 'Contract' %}selected{% endif %}>Contract</option>
              <option value="Internship" {% if (form_data.employment_type if form_data else job.employment_type) == 'Internship' %}selected{% endif %}>Internship</option>
            </select>
          </div>
          <div class="form-group">
            <label for="seniority" class="form-label">Seniority</label>
            <input id="seniority" name="seniority" class="form-input {{ 'has-error' if errors and errors.seniority else '' }}"
              placeholder="e.g. Senior" value="{{ (form_data.seniority if form_data else job.seniority) or '' }}" maxlength="100" />
            {% if errors and errors.seniority %}<div class="form-error">{{ errors.seniority }}</div>{% endif %}
          </div>
          <div class="form-group">
            <label for="salary_range_text" class="form-label">Salary range</label>
            <input id="salary_range_text" name="salary_range_text" class="form-input {{ 'has-error' if errors and errors.salary_range_text else '' }}"
              placeholder="e.g. $160k–$210k" value="{{ (form_data.salary_range_text if form_data else job.salary_range_text) or '' }}" maxlength="255" />
            {% if errors and errors.salary_range_text %}<div class="form-error">{{ errors.salary_range_text }}</div>{% endif %}
          </div>
        </div>

        <div class="divider">
          {% if job.status == 'published' %}
          <button type="button" class="btn btn-secondary btn-block" onclick="submitForm('draft')">Unpublish (revert to draft)</button>
          {% else %}
          <button type="button" class="btn btn-secondary btn-block" onclick="submitForm('published')">Publish now</button>
          {% endif %}
          <button type="button" class="btn-danger-outline btn-block" style="margin-top: 0.75rem;" onclick="deleteJob('{{ job.id }}')">Delete job</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Job description</div>
      <div class="card-body" style="padding: 0;">
        <div id="editor" class="editor-wrap"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">AI assistance</div>
      <div class="card-body">
        <label for="focus_areas" class="form-label">Key requirements (for AI-generated description)</label>
        <textarea id="focus_areas" name="focus_areas" rows="3" class="form-input" placeholder="e.g. 5+ years Python, team lead experience…" style="resize: vertical; min-height: 80px;"></textarea>
        <p class="form-hint">Used when you click “Regenerate with AI” below. Leave blank to use job title and details only.</p>
        <button type="button" class="btn btn-secondary" style="margin-top: 0.75rem;" onclick="generateJD()" id="gen-jd-btn">Regenerate description with AI</button>
        <span id="gen-jd-status" style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.8125rem;"></span>
      </div>
    </div>
  </form>
</div>

<div id="initial-content" style="display:none;">{% if (form_data and form_data.description_html) or job.description_html %}{{ (form_data.description_html if form_data else job.description_html) | safe }}{% else %}{{ (form_data.description_raw if form_data else job.description_raw) or '' }}{% endif %}</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  var quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'Write a detailed job description…',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        ['link', 'clean']
      ]
    }
  });
  var initialContent = document.getElementById('initial-content').innerHTML;
  if (initialContent) {
    if (initialContent.includes('<')) quill.clipboard.dangerouslyPasteHTML(initialContent);
    else quill.setText(initialContent);
  }
  function submitForm(statusVal) {
    document.getElementById('status').value = statusVal;
    document.getElementById('description_html').value = quill.root.innerHTML;
    document.getElementById('description_raw').value = quill.getText();
    if (statusVal === 'published' && '{{ job.status }}' !== 'published') {
      if (!confirm('Publish this job? It will be live immediately.')) return;
    }
    document.getElementById('jobForm').submit();
  }
  async function generateJD() {
    var title = document.getElementById('title').value.trim();
    if (!title) { alert('Please enter a job title first.'); return; }
    if (!confirm('This will overwrite the current description. Continue?')) return;
    var btn = document.getElementById('gen-jd-btn');
    var status = document.getElementById('gen-jd-status');
    btn.disabled = true;
    status.textContent = 'Generating…';
    try {
      var body = {
        title: title,
        department: document.getElementById('department').value.trim(),
        location: document.getElementById('location').value.trim(),
        employment_type: document.getElementById('employment_type').value,
        seniority: document.getElementById('seniority').value.trim(),
        focus_areas: document.getElementById('focus_areas').value.trim()
      };
      {% if job.company %}body.company_id = '{{ job.company.id }}';{% else %}body.company_name = '{{ job.company_name or "" }}'; body.company_website = '{{ job.company_website or "" }}';{% endif %}
      var resp = await fetch('/api/jobs/ai-generate-jd', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify(body) });
      var data = await resp.json();
      if (!resp.ok || data.error) throw new Error(data.error || 'Failed');
      var content = '';
      if (data.full_description) content = data.full_description.replace(/\n/g, '<br>');
      else {
        if (data.headline) content += '<h1>' + data.headline + '</h1><p>' + (data.summary || '') + '</p><br>';
        if (Array.isArray(data.responsibilities) && data.responsibilities.length) content += '<h2>Responsibilities</h2><ul>' + data.responsibilities.map(function(i){ return '<li>' + i + '</li>'; }).join('') + '</ul><br>';
        if (Array.isArray(data.requirements) && data.requirements.length) content += '<h2>Requirements</h2><ul>' + data.requirements.map(function(i){ return '<li>' + i + '</li>'; }).join('') + '</ul><br>';
        if (Array.isArray(data.benefits) && data.benefits.length) content += '<h2>Benefits</h2><ul>' + data.benefits.map(function(i){ return '<li>' + i + '</li>'; }).join('') + '</ul><br>';
      }
      if (!content.includes('<')) content = content.replace(/\n/g, '<br>');
      content = content.replace(/^# (.*$)/gim, '<h1>$1</h1>').replace(/^## (.*$)/gim, '<h2>$1</h2>').replace(/^\- (.*$)/gim, '<li>$1</li>');
      quill.clipboard.dangerouslyPasteHTML(content);
      status.textContent = 'Done.';
    } catch (e) {
      status.textContent = '';
      alert('Error: ' + e.message);
    }
    btn.disabled = false;
    setTimeout(function(){ status.textContent = ''; }, 3000);
  }
  function deleteJob(jobId) {
    if (!confirm('Delete this job? This cannot be undone.')) return;
    fetch('/jobs/' + jobId, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin' })
      .then(function(r){ return r.json(); })
      .then(function(data){ if (data.error) alert('Error: ' + data.error); else window.location.href = '/jobs'; })
      .catch(function(err){ alert('Error: ' + err.message); });
  }
</script>
{% endblock %}
