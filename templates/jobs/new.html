{% extends "base.html" %}
{% block title %}New Job - RefCheck AI{% endblock %}

{% block extra_head %}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
  .ql-container {
    font-family: inherit;
    font-size: 1rem;
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
    background: var(--bg-card);
  }

  .ql-toolbar {
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
    background: var(--bg-secondary);
    border-color: var(--border-light);
  }

  .ql-container.ql-snow {
    border-color: var(--border-light);
  }

  .split-layout {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 1.5rem;
    align-items: start;
  }

  @media (max-width: 900px) {
    .split-layout {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
  {% if company %}
  <a href="{{ url_for('companies.view_company', company_id=company.id) }}"
    style="color: var(--text-muted); font-size: 0.9rem;">← Back to {{ company.name }}</a>
  {% else %}
  <a href="{{ url_for('jobs.jobs') }}" style="color: var(--text-muted); font-size: 0.9rem;">← Back to Jobs</a>
  {% endif %}
  <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
    <div>
      <h1 style="font-size: 1.75rem; font-weight: 600; letter-spacing: -0.02em; margin-bottom: 0.25rem;">Create Job</h1>
      <p style="color: var(--text-secondary); margin:0;">Draft the perfect job post. You can refine and publish later.
      </p>
    </div>
    <div style="display:flex; gap: 0.75rem;">
      <a class="btn btn-secondary"
        href="{{ url_for('companies.view_company', company_id=company.id) if company else url_for('jobs.jobs') }}">Cancel</a>
      <button class="btn btn-primary" onclick="submitForm('draft')">Save Draft</button>
    </div>
  </div>
</div>

<form method="POST" action="{{ url_for('jobs.create_job', company_id=company.id) }}" id="jobForm">
  <input type="hidden" name="status" id="status" value="draft">
  <input type="hidden" name="description_html" id="description_html">
  <input type="hidden" name="description_raw" id="description_raw">

  <div class="split-layout">
    <!-- Left Column: Metadata -->
    <div style="display:flex; flex-direction: column; gap: 1rem;">
      <div class="card">
        <div class="card-header">Details</div>
        <div class="card-body">
          {% if company %}
          <div class="form-group">
            <label>Company</label>
            <div
              style="padding: 0.5rem 0.75rem; background: var(--bg-secondary); border-radius: 6px; font-size: 0.9rem;">
              <strong>{{ company.name }}</strong>
            </div>
          </div>
          {% endif %}

          <div class="form-group">
            <label for="title">Job Title *</label>
            <input id="title" name="title" placeholder="e.g., Senior Engineer" required />
          </div>

          <div class="form-group">
            <label for="department">Department</label>
            <input id="department" name="department" placeholder="e.g., Engineering" />
          </div>

          <div class="form-group">
            <label for="location">Location</label>
            <input id="location" name="location" placeholder="e.g., Remote" />
          </div>

          <div class="form-group">
            <label for="employment_type">Type</label>
            <select id="employment_type" name="employment_type">
              <option value="">—</option>
              <option value="Full-time">Full-time</option>
              <option value="Part-time">Part-time</option>
              <option value="Contract">Contract</option>
              <option value="Internship">Internship</option>
            </select>
          </div>

          <div class="form-group">
            <label for="seniority">Seniority</label>
            <input id="seniority" name="seniority" placeholder="e.g., Senior" />
          </div>

          <div class="form-group">
            <label for="salary_range_text">Salary Range</label>
            <input id="salary_range_text" name="salary_range_text" placeholder="e.g., $160k–$210k" />
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">AI Assistance</div>
        <div class="card-body">
          <div class="form-group">
            <label for="focus_areas" style="font-size: 0.85rem;">Key Requirements (Bullet points)</label>
            <textarea id="focus_areas" name="focus_areas" rows="5" style="font-size: 0.9rem;"
              placeholder="- 5+ years Python&#10;- React experience&#10;- Remote ok"></textarea>
            <button type="button" class="btn btn-secondary btn-sm" onclick="generateJD()" id="gen-jd-btn"
              style="width:100%; margin-top: 0.5rem; justify-content: center;">✨ Generate with AI</button>
            <span id="gen-jd-status"
              style="display:block; margin-top:0.5rem; color: var(--text-muted); font-size: 0.8rem; text-align: center;"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Description -->
    <div class="card" style="min-height: 600px; display:flex; flex-direction:column;">
      <div class="card-header" style="justify-content: space-between;">
        <span>Job Description</span>
        <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: 400;">Extensive editing enabled</span>
      </div>
      <div class="card-body" style="flex:1; display:flex; flex-direction:column; padding: 0;">
        <div id="editor" style="flex:1; border:none;"></div>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  var quill = new Quill('#editor', {
    theme: 'snow',
    placeholder: 'Write a detailed job description...',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        ['link', 'clean']
      ]
    }
  });

  function submitForm(statusVal) {
    document.getElementById('status').value = statusVal;

    // Populate hidden inputs
    document.getElementById('description_html').value = quill.root.innerHTML;
    document.getElementById('description_raw').value = quill.getText(); // Fallback raw text

    if (statusVal === 'published') {
      if (!confirm('Publish this job? It will be live immediately.')) return;
    }

    document.getElementById('jobForm').submit();
  }

  async function generateJD() {
    const title = document.getElementById('title').value.trim();
    if (!title) { alert('Please enter a job title first'); return; }

    const btn = document.getElementById('gen-jd-btn');
    const status = document.getElementById('gen-jd-status');
    const focusAreas = document.getElementById('focus_areas').value.trim();

    // Gather other fields
    const dept = document.getElementById('department').value.trim();
    const loc = document.getElementById('location').value.trim();
    const emp = document.getElementById('employment_type').value.trim();
    const sen = document.getElementById('seniority').value.trim();

    btn.disabled = true;
    status.textContent = 'Generating...';

    try {
      const requestBody = {
        title,
        department: dept,
        location: loc,
        employment_type: emp,
        seniority: sen,
        focus_areas: focusAreas
      };

      {% if company %}
      requestBody.company_id = '{{ company.id }}';
      {% endif %}

      const resp = await fetch('/api/jobs/ai-generate-jd', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(requestBody)
      });

      const data = await resp.json();
      if (!resp.ok || data.error) throw new Error(data.error || 'Failed');

      let content = '';

      // Prefer full description if available
      if (data.full_description) {
        // Basic markdown-to-html converter (very simple) or just inject as text
        // Ideally we should interpret the markdown. For now, since Quill pastes HTML well,
        // let's format it slightly.
        content = data.full_description.replace(/\n/g, '<br>');
      } else {
        // Fallback construction
        if (data.headline) content += `<h1>${data.headline}</h1><p>${data.summary}</p><br>`;

        const buildList = (title, items) => {
          if (!items || !items.length) return '';
          let html = `<h2>${title}</h2><ul>`;
          items.forEach(i => html += `<li>${i}</li>`);
          html += '</ul><br>';
          return html;
        };

        content += buildList('Responsibilities', data.responsibilities);
        content += buildList('Requirements', data.requirements);
        content += buildList('Benefits', data.benefits);
      }

      // Use clipboard API or just insert
      // Ideally we want to properly format markdown to HTML for Quill.
      // Since the AI returns Markdown-ish text, we might need a parser. 
      // For simplicity efficiently, we will just set the text and let user format, OR try to format heavily.
      // Let's just set the content.

      // Better Approach: Just insert text and let Quill handle it?
      // Quill.setText() clears formatting.
      // Let's use clipboard matchers or just pasteHTML.

      // Check if content looks like HTML, if not, wrap in p
      if (!content.includes('<')) {
        content = content.replace(/\n/g, '<br>');
      }

      // If we have markdown headers (# ), replace them
      content = content
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^\- (.*$)/gim, '<li>$1</li>');

      quill.clipboard.dangerouslyPasteHTML(content);

      status.textContent = 'Generated!';
    } catch (e) {
      status.textContent = '';
      alert('Error: ' + e.message);
    } finally {
      btn.disabled = false;
      setTimeout(() => { status.textContent = ''; }, 3000);
    }
  }
</script>
{% endblock %}