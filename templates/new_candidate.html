{% extends "base.html" %}
{% block title %}Add New Candidate - RefCheck AI{% endblock %}

{% block extra_styles %}
<style>
    .page-header { margin-bottom: 2rem; }
    .page-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
    .page-subtitle { color: var(--text-secondary); }
    
    .steps { display: flex; gap: 0.5rem; margin-bottom: 2rem; }
    .step { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 100px; font-size: 0.85rem; font-weight: 500; background: var(--bg-tertiary); color: var(--text-muted); }
    .step.active { background: var(--accent); color: white; }
    .step.completed { background: var(--success-bg); color: var(--success); }
    .step-number { width: 20px; height: 20px; border-radius: 50%; background: currentColor; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
    .step.active .step-number { background: rgba(255,255,255,0.3); }
    .step.completed .step-number { background: var(--success); }
    
    .card-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .card-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
    
    .file-upload { border: 2px dashed var(--border); border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.15s; background: var(--bg-secondary); }
    .file-upload:hover { border-color: var(--accent); background: var(--accent-bg); }
    .file-upload.dragover { border-color: var(--accent); background: var(--accent-bg); }
    .file-upload-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .file-upload-text { color: var(--text-secondary); font-size: 0.9rem; }
    .file-input { display: none; }
    
    .selected-file { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: var(--accent-bg); border-radius: 8px; margin-top: 1rem; }
    .selected-file-name { flex: 1; font-weight: 500; font-size: 0.9rem; }
    .selected-file-remove { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.25rem; line-height: 1; }
    
    .btn-group { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
    
    .jobs-list { display: flex; flex-direction: column; gap: 1.5rem; }
    .job-card { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .job-header { padding: 1rem 1.25rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start; }
    .job-company { font-weight: 600; font-size: 1rem; }
    .job-title { color: var(--text-secondary); font-size: 0.9rem; }
    .job-dates { font-size: 0.8rem; color: var(--text-muted); background: var(--bg-primary); padding: 0.25rem 0.5rem; border-radius: 4px; }
    .job-body { padding: 1.25rem; }
    .job-section { margin-bottom: 1.25rem; }
    .job-section:last-child { margin-bottom: 0; }
    .job-section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600; }
    .job-item { display: flex; gap: 0.5rem; margin-bottom: 0.375rem; font-size: 0.875rem; color: var(--text-secondary); }
    .job-item-icon { flex-shrink: 0; }
    .job-item-icon.resp { color: var(--accent); }
    .job-item-icon.ach { color: var(--success); }
    
    .reference-section { margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px solid var(--border); }
    .reference-section-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .reference-list { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }
    .reference-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border); }
    .reference-info { flex: 1; }
    .reference-name { font-weight: 500; font-size: 0.9rem; }
    .reference-phone { font-size: 0.8rem; color: var(--text-muted); }
    .reference-remove { background: none; border: none; color: var(--danger); cursor: pointer; padding: 0.25rem; }
    
    .add-reference-form { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .add-reference-form input { padding: 0.625rem 0.875rem; font-size: 0.85rem; }
    .add-reference-btn { grid-column: span 2; }
    @media (max-width: 640px) { .add-reference-form { grid-template-columns: 1fr; } .add-reference-btn { grid-column: span 1; } }
    
    .custom-questions { margin-top: 1rem; }
    .custom-questions textarea { min-height: 80px; font-size: 0.85rem; }
    
    .action-footer { position: sticky; bottom: 0; background: var(--bg-primary); border-top: 1px solid var(--border); padding: 1rem 2rem; margin: 2rem -2rem -2rem; display: flex; justify-content: space-between; align-items: center; }
    
    .success-card { text-align: center; padding: 3rem; }
    .success-icon { font-size: 3rem; margin-bottom: 1rem; }

    /* Modal Styles */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .modal.hidden { display: none; }
    .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); }
    .modal-content { position: relative; background: var(--bg-primary); border-radius: 12px; max-width: 700px; max-height: 85vh; width: 90%; display: flex; flex-direction: column; box-shadow: var(--shadow-lg); }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-header h3 { font-size: 1.25rem; font-weight: 600; margin: 0; }
    .modal-close { background: none; border: none; font-size: 2rem; color: var(--text-muted); cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px; }
    .modal-close:hover { color: var(--text-primary); }
    .modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 0.75rem; justify-content: flex-end; }

    .question-section { margin-bottom: 2rem; }
    .question-section:last-child { margin-bottom: 0; }
    .question-section-title { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; }
    .question-item { margin-bottom: 1rem; }
    .question-item:last-child { margin-bottom: 0; }
    .question-label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.25rem; }
    .question-input { width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; font-family: inherit; }
    .question-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-bg); }
    .question-type { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Add New Candidate</h1>
    <p class="page-subtitle">Upload a resume and configure reference checks</p>
</div>

<div class="steps">
    <div class="step active" id="step1-indicator"><span class="step-number">1</span> Upload Resume</div>
    <div class="step" id="step2-indicator"><span class="step-number">2</span> Add References</div>
    <div class="step" id="step3-indicator"><span class="step-number">3</span> Start Outreach</div>
</div>

<!-- Step 1: Upload Resume -->
<section id="step1">
    <div class="card">
        <div class="card-body">
            <div class="card-title"><span class="card-icon">üìÑ</span> Candidate Information</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="candidate-name">Candidate Name (optional)</label>
                    <input type="text" id="candidate-name" placeholder="Will be extracted from resume">
                </div>
                <div class="form-group">
                    <label for="position">Position Applied For *</label>
                    <input type="text" id="position" placeholder="e.g., Senior Software Engineer" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Resume Upload *</label>
                <div class="file-upload" id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <div class="file-upload-icon">üìÅ</div>
                    <p class="file-upload-text">Drop resume here or click to browse</p>
                    <p class="hint">PDF, DOC, DOCX, or TXT (max 16MB)</p>
                </div>
                <input type="file" id="file-input" class="file-input" accept=".pdf,.doc,.docx,.txt">
                <div id="selected-file" class="selected-file hidden">
                    <span>üìÑ</span>
                    <span class="selected-file-name" id="selected-file-name"></span>
                    <button class="selected-file-remove" onclick="clearFile()">√ó</button>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" id="parse-btn" onclick="parseResume()">Parse Resume ‚Üí</button>
            </div>
        </div>
    </div>
</section>

<!-- Step 2: Add References -->
<section id="step2" class="hidden">
    <div class="card mb-2">
        <div class="card-body">
            <div class="card-title">
                <span class="card-icon">üë§</span>
                <span id="candidate-display-name">Candidate Name</span>
                <span style="font-weight: 400; color: var(--text-muted); font-size: 0.9rem; margin-left: auto;" id="position-display"></span>
            </div>
            <p id="candidate-summary" style="color: var(--text-secondary); font-size: 0.9rem;"></p>
        </div>
    </div>
    
    <div class="card mb-2">
        <div class="card-body">
            <div class="card-title"><span class="card-icon">üíº</span> Work History & References</div>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.5rem;">Add at least one reference for each role. You can also add custom questions.</p>
            <div class="jobs-list" id="jobs-list"></div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <div class="card-title"><span class="card-icon">üí¨</span> SMS Follow-up Template</div>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">If a reference doesn't answer, this message will be sent via SMS.</p>
            <div class="form-group">
                <label for="sms-template">SMS Message</label>
                <textarea id="sms-template">{{ sms_template }}</textarea>
                <p class="hint">Variables: {candidate_first_name}, {candidate_last_name}</p>
            </div>
        </div>
    </div>
    
    <div class="action-footer">
        <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
        <button class="btn btn-primary" onclick="continueToStep3()">Continue</button>
    </div>
</section>

<!-- Step 3: Ready to Start -->
<section id="step3" class="hidden">
    <div class="card">
        <div class="card-body">
            <div class="card-title">Ready to Begin Reference Checks</div>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Your candidate has been saved with <span id="ref-count">0</span> reference(s).
                You can start outreach now or come back later to manage references.
            </p>

            <div class="btn-group">
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
                <a href="" class="btn btn-secondary" id="view-candidate-link">View Candidate</a>
                <button class="btn btn-primary" id="start-outreach-btn" onclick="startOutreach()">Start Reference Outreach</button>
            </div>
        </div>
    </div>
</section>

<!-- Survey Preview Modal -->
<div id="survey-modal" class="modal hidden">
    <div class="modal-overlay" onclick="closeSurveyModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Survey Questions Preview</h3>
            <button class="modal-close" onclick="closeSurveyModal()">√ó</button>
        </div>
        <div class="modal-body" id="survey-modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                These questions will be sent if you select email survey as the contact method. You can edit any question.
            </p>
            <div id="survey-questions-container"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeSurveyModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveSurveyQuestions()">Save Questions</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let candidateId = null;
    let candidateData = null;
    let selectedFile = null;
    
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault(); dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
    });
    
    function handleFileSelect(file) {
        if (!file.name.match(/\.(pdf|txt|doc|docx)$/i)) { alert('Please upload a PDF, DOC, DOCX, or TXT file'); return; }
        selectedFile = file;
        document.getElementById('selected-file').classList.remove('hidden');
        document.getElementById('selected-file-name').textContent = file.name;
        dropZone.style.display = 'none';
    }
    
    function clearFile() {
        selectedFile = null; fileInput.value = '';
        document.getElementById('selected-file').classList.add('hidden');
        dropZone.style.display = 'block';
    }
    
    function goToStep(step) {
        document.getElementById('step1').classList.toggle('hidden', step !== 1);
        document.getElementById('step2').classList.toggle('hidden', step !== 2);
        document.getElementById('step3').classList.toggle('hidden', step !== 3);
        document.getElementById('step1-indicator').className = `step ${step === 1 ? 'active' : step > 1 ? 'completed' : ''}`;
        document.getElementById('step2-indicator').className = `step ${step === 2 ? 'active' : step > 2 ? 'completed' : ''}`;
        document.getElementById('step3-indicator').className = `step ${step === 3 ? 'active' : ''}`;
    }
    
    async function parseResume() {
        const position = document.getElementById('position').value.trim();
        const candidateName = document.getElementById('candidate-name').value.trim();
        const smsTemplate = document.getElementById('sms-template').value;
        
        if (!position) { alert('Please enter the position applied for'); return; }
        if (!selectedFile) { alert('Please upload a resume'); return; }
        
        const btn = document.getElementById('parse-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Parsing...';
        
        try {
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('position', position);
            formData.append('sms_template', smsTemplate);
            if (candidateName) formData.append('candidate_name', candidateName);
            
            const response = await fetch('/api/candidates', { method: 'POST', body: formData });
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            
            candidateId = data.candidate_id;
            candidateData = data.candidate;
            renderStep2();
            goToStep(2);
        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Parse Resume ‚Üí';
        }
    }
    
    function renderStep2() {
        document.getElementById('candidate-display-name').textContent = candidateData.name;
        document.getElementById('position-display').textContent = candidateData.position;
        document.getElementById('candidate-summary').textContent = candidateData.summary || '';
        
        const container = document.getElementById('jobs-list');
        container.innerHTML = candidateData.jobs.map((job, index) => `
            <div class="job-card" data-index="${index}">
                <div class="job-header">
                    <div>
                        <div class="job-company">${escapeHtml(job.company)}</div>
                        <div class="job-title">${escapeHtml(job.title)}</div>
                    </div>
                    <div class="job-dates">${escapeHtml(job.dates)}</div>
                </div>
                <div class="job-body">
                    ${job.responsibilities?.length ? `<div class="job-section"><div class="job-section-title">Responsibilities</div>${job.responsibilities.map(r => `<div class="job-item"><span class="job-item-icon resp">‚óã</span><span>${escapeHtml(r)}</span></div>`).join('')}</div>` : ''}
                    ${job.achievements?.length ? `<div class="job-section"><div class="job-section-title">Achievements</div>${job.achievements.map(a => `<div class="job-item"><span class="job-item-icon ach">‚òÖ</span><span>${escapeHtml(a)}</span></div>`).join('')}</div>` : ''}
                    <div class="reference-section">
                        <div class="reference-section-title"><span>üë•</span> References for this role</div>
                        <div class="reference-list" id="refs-${index}"><p style="color: var(--text-muted); font-size: 0.85rem;">No references added yet</p></div>
                        <div class="add-reference-form" style="grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <input type="text" id="ref-name-${index}" placeholder="Reference name *">
                            <select id="ref-relationship-${index}">
                                <option value="">Relationship...</option>
                                <option value="Manager">Manager</option>
                                <option value="Direct Supervisor">Direct Supervisor</option>
                                <option value="Colleague">Colleague</option>
                                <option value="Direct Report">Direct Report</option>
                                <option value="Client">Client</option>
                                <option value="Other">Other</option>
                            </select>
                            <input type="tel" id="ref-phone-${index}" placeholder="Phone (optional)">
                            <input type="email" id="ref-email-${index}" placeholder="Email (optional)">
                            <select id="ref-contact-method-${index}">
                                <option value="survey_only">Email Survey Only</option>
                                <option value="call_only">Phone Call Only</option>
                                <option value="call_and_survey">Both Call & Survey</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" onclick="previewSurvey(${index})" id="preview-btn-${index}" disabled>Generate & Preview Survey Questions</button>
                            <button class="btn btn-secondary btn-sm add-reference-btn" onclick="addReference(${index})" style="grid-column: span 2;">+ Add Reference</button>
                        </div>
                        <div class="custom-questions">
                            <label for="custom-q-${index}">Custom Questions (optional)</label>
                            <textarea id="custom-q-${index}" placeholder="Add specific questions for the AI to ask. One per line."></textarea>
                            <p class="hint">These will be asked in addition to standard verification questions</p>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');

        // Add event listeners to enable preview button when name is filled
        candidateData.jobs.forEach((job, index) => {
            const nameInput = document.getElementById(`ref-name-${index}`);
            nameInput.addEventListener('input', () => {
                const previewBtn = document.getElementById(`preview-btn-${index}`);
                previewBtn.disabled = !nameInput.value.trim();
            });
        });
    }
    
    async function addReference(jobIndex) {
        const name = document.getElementById(`ref-name-${jobIndex}`).value.trim();
        const phone = document.getElementById(`ref-phone-${jobIndex}`).value.trim();
        const email = document.getElementById(`ref-email-${jobIndex}`).value.trim();
        const relationship = document.getElementById(`ref-relationship-${jobIndex}`).value;
        const contactMethod = document.getElementById(`ref-contact-method-${jobIndex}`).value;
        const customQInput = document.getElementById(`custom-q-${jobIndex}`);
        const customQuestions = customQInput.value.trim().split('\n').filter(q => q.trim());

        // Validation: name is required
        if (!name) {
            alert('Please enter the reference name');
            return;
        }

        // Validation: at least phone OR email required
        if (!phone && !email) {
            alert('Please provide either a phone number or email address');
            return;
        }

        // Validation: contact method must match available contact info
        if ((contactMethod === 'call_only' || contactMethod === 'call_and_survey') && !phone) {
            alert('Phone number is required for call-based contact methods');
            return;
        }
        if ((contactMethod === 'survey_only' || contactMethod === 'call_and_survey') && !email) {
            alert('Email address is required for survey-based contact methods');
            return;
        }

        try {
            const response = await fetch(`/api/candidates/${candidateId}/references`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reference_name: name,
                    reference_phone: phone || null,
                    reference_email: email || null,
                    relationship: relationship || null,
                    contact_method: contactMethod,
                    job_index: jobIndex,
                    custom_questions: customQuestions
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            if (!candidateData.references) candidateData.references = [];
            candidateData.references.push(data.reference);
            renderReferences(jobIndex);

            // Clear form
            document.getElementById(`ref-name-${jobIndex}`).value = '';
            document.getElementById(`ref-phone-${jobIndex}`).value = '';
            document.getElementById(`ref-email-${jobIndex}`).value = '';
            document.getElementById(`ref-relationship-${jobIndex}`).selectedIndex = 0;
            document.getElementById(`ref-contact-method-${jobIndex}`).selectedIndex = 0;
        } catch (error) { alert('Error: ' + error.message); }
    }
    
    function renderReferences(jobIndex) {
        const refs = (candidateData.references || []).filter(r => {
            const jobs = candidateData.jobs;
            const jobId = jobs[jobIndex]?.id;
            return r.job_id === jobId || (!r.job_id && jobIndex === 0);
        });
        const container = document.getElementById(`refs-${jobIndex}`);
        
        if (refs.length === 0) {
            container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.85rem;">No references added yet</p>';
            return;
        }
        
        container.innerHTML = refs.map(ref => {
            const contactInfo = [];
            if (ref.phone) contactInfo.push(escapeHtml(ref.phone));
            if (ref.email) contactInfo.push(escapeHtml(ref.email));
            const contactMethodLabel = {
                'call_only': 'Phone Call',
                'survey_only': 'Email Survey',
                'call_and_survey': 'Call & Survey'
            }[ref.contact_method] || 'Email Survey';

            return `
                <div class="reference-item">
                    <div class="reference-info">
                        <div class="reference-name">${escapeHtml(ref.name)}${ref.relationship ? ` (${escapeHtml(ref.relationship)})` : ''}</div>
                        <div class="reference-phone">${contactInfo.join(' ‚Ä¢ ')} ‚Ä¢ ${contactMethodLabel}</div>
                    </div>
                    <button class="reference-remove" onclick="removeReference('${ref.id}', ${jobIndex})">√ó</button>
                </div>
            `;
        }).join('');
    }
    
    async function removeReference(refId, jobIndex) {
        try {
            await fetch(`/api/candidates/${candidateId}/references/${refId}`, { method: 'DELETE' });
            candidateData.references = candidateData.references.filter(r => r.id !== refId);
            renderReferences(jobIndex);
        } catch (error) { alert('Error: ' + error.message); }
    }
    
    async function continueToStep3() {
        // Save SMS template
        const smsTemplate = document.getElementById('sms-template').value;
        await fetch(`/api/candidates/${candidateId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sms_template: smsTemplate })
        });

        // Update step 3 with reference count and links
        const refCount = (candidateData.references || []).length;
        document.getElementById('ref-count').textContent = refCount;
        document.getElementById('view-candidate-link').href = `/candidate/${candidateId}`;

        // Go to step 3 without starting outreach
        goToStep(3);
    }

    async function startOutreach() {
        const refs = candidateData.references || [];
        if (refs.length === 0) {
            alert('Please add at least one reference before starting outreach');
            return;
        }

        const btn = document.getElementById('start-outreach-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Starting...';

        try {
            const response = await fetch(`/api/candidates/${candidateId}/start-outreach`, { method: 'POST' });
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            // Show success and redirect to candidate page
            alert('Reference outreach started! Redirecting to candidate details...');
            window.location.href = `/candidate/${candidateId}`;
        } catch (error) {
            alert('Error: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = 'Start Reference Outreach';
        }
    }

    // Survey Preview Modal Functions
    let currentJobIndex = null;
    let surveyQuestions = [];

    async function previewSurvey(jobIndex) {
        const name = document.getElementById(`ref-name-${jobIndex}`).value.trim();
        if (!name) {
            alert('Please enter the reference name first');
            return;
        }

        currentJobIndex = jobIndex;
        const btn = document.getElementById(`preview-btn-${jobIndex}`);
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Generating...';

        try {
            const job = candidateData.jobs[jobIndex];

            // Call API to generate questions (this will generate AI questions)
            const response = await fetch(`/api/generate-survey-questions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    candidate_name: name,
                    job_title: job.title,
                    job_company: job.company,
                    job_dates: job.dates,
                    responsibilities: job.responsibilities || [],
                    achievements: job.achievements || [],
                    target_position: candidateData.position
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            surveyQuestions = data.questions || [];
            renderSurveyModal();
            document.getElementById('survey-modal').classList.remove('hidden');
        } catch (error) {
            alert('Error generating questions: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    function renderSurveyModal() {
        const container = document.getElementById('survey-questions-container');

        // Group questions by type
        const standardQuestions = surveyQuestions.filter(q => q.type === 'standardized');
        const aiQuestions = surveyQuestions.filter(q => q.type === 'ai_generated');

        let html = '';

        // Standard questions
        if (standardQuestions.length > 0) {
            html += '<div class="question-section">';
            html += '<div class="question-section-title">Standard Questions (' + standardQuestions.length + ')</div>';
            standardQuestions.forEach((q, idx) => {
                html += `
                    <div class="question-item">
                        <label class="question-label">${idx + 1}. Question</label>
                        <input type="text" class="question-input" data-index="${q.index}" value="${escapeHtml(q.question)}">
                        <div class="question-type">${q.answer_type || 'Text response'}</div>
                    </div>
                `;
            });
            html += '</div>';
        }

        // AI-generated questions
        if (aiQuestions.length > 0) {
            html += '<div class="question-section">';
            html += '<div class="question-section-title">AI-Generated Questions (' + aiQuestions.length + ')</div>';
            aiQuestions.forEach((q, idx) => {
                html += `
                    <div class="question-item">
                        <label class="question-label">${idx + 1}. Question</label>
                        <input type="text" class="question-input" data-index="${q.index}" value="${escapeHtml(q.question)}">
                        <div class="question-type">${q.answer_type || 'Text response'}</div>
                    </div>
                `;
            });
            html += '</div>';
        }

        container.innerHTML = html;
    }

    function closeSurveyModal() {
        document.getElementById('survey-modal').classList.add('hidden');
        currentJobIndex = null;
        surveyQuestions = [];
    }

    function saveSurveyQuestions() {
        // Get all edited question values
        const inputs = document.querySelectorAll('#survey-questions-container .question-input');
        const editedQuestions = Array.from(inputs).map((input, idx) => input.value.trim()).filter(q => q);

        if (currentJobIndex !== null) {
            // Save to custom questions field (will replace all questions as per requirement)
            const customQTextarea = document.getElementById(`custom-q-${currentJobIndex}`);
            customQTextarea.value = editedQuestions.join('\n');
        }

        closeSurveyModal();
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
